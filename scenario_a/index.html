<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Quality Improvement Training</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">

</head>
<body>
    <main>
        <!-- Single Chat Interface -->
        <div class="chat-interface">
            <!-- Scenario Selection Header -->
            <div class="scenario-header">
                <div class="scenario-info">
                    
                    <h2 id="current-scenario-name">Select a Scenario</h2>
                    <p id="current-scenario-description">Choose a training scenario to begin interviewing staff</p>
                    
                </div>
            </div>

            <!-- Main Chat Container -->
            <div class="main-chat-container">
                <!-- Staff Selection Panel -->
                <div class="staff-panel">
                    <h3><i class="fas fa-users"></i> Available Roles</h3>
                    <div id="staff-list">
                        <!-- Staff members will be populated here -->
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="chat-area">
                    <div class="chat-header" id="chat-header">
                        <span>Select a role to begin interview</span>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-placeholder">
                            <i class="fas fa-comments"></i>
                            <p>Select a role from the panel to start the interview</p>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <div class="chat-input-group">
                            <input type="text" class="chat-input" id="message-input" 
                                   placeholder="Ask about processes and quality issues..."
                                   onkeypress="handleChatKeyPress(event)"
                                   disabled>
                            <button data-primary onclick="sendMessage()" id="send-btn" disabled>
                                <i class="fas fa-paper-plane"></i>
                                <span>Send</span>
                            </button>
                            <button data-danger onclick="downloadTranscriptRTF()" id="download-transcript-btn" title="Download Transcript">
                                <i class="fas fa-download"></i>
                                <span class="download-text">Download</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modal-container"></div>

    <script>
        // ========================================
        // SCENARIO CONFIGURATION 
        // ========================================
        // Update this section for each scenario
        const SCENARIO_CONFIG = {
            id: 'lab-timing-delays',
            name: 'Lab Timing Delays Investigation',
            description: 'Investigate why morning labs are not being drawn and reported in a timely manner.',
            characters: [
                {
                    id: 'physician-001',
                    name: 'Dr. Sarah Chen',
                    occupation: 'Physician',
                    attitude: 'Just want to see things fixed and don\'t understand why they are so broken. Helpful however they can but have limited knowledge outside of knowing it makes their job harder.',
                    knowledge: 'Lab results are supposed to be back by 7:30 AM per hospital policy. Lab delays are happening per the opinion of physicians and it is affecting their ability to provide medical care. I put in at least two patient safety reports. One patient\'s discharge was delayed because the only ride available left before we had morning lab results. Another patient had to receive his medications much later in the day because of lab delays that I needed for dosing. In general, I think lab delays are happening more frequently. I typically get sign out around 7:15 AM, so if I could have all results back by 7:30 AM I would have all the information I need when I start rounds.'
                },
                {
                    id: 'lab-tech-001',
                    name: 'Mike Rodriguez',
                    occupation: 'Lab Tech',
                    attitude: 'No nonsense, succinct, they understand the system and directly and clearly answer questions.',
                    knowledge: 'When specimens arrive, I remove them from the pneumatic tube and stack all of them in the lab analyzer. The analyzer reads the barcode and performs the appropriate test. The analyzer takes 35 minutes to run a CBC and 42 minutes to run a BMP. Once analyzed, a lab tech will confirm the results, look for suspicious outliers, and release the report to the electronic medical record which on average takes 4-5 minutes from the time the analyzer finishes. I have data on how long everything takes in our lab. Overall, it takes 47 minutes to result a BMP & 39 minutes to result a CBC from the time we receive the blood until the time it is reported in the medical record. Plus, we have a very low standard deviation of only +/-3 minutes. Which means the delays in labs being reported on time doesn\'t stem from us. We are pretty consistent and don\'t have a lot we can change given the fixed time it takes the analyzer to run. Furthermore, our analyzers are top tier, you can\'t get much faster than these machines go! These machines can handle a lot of labs. I don\'t think it would be a big deal for the instrument, but we may need to adjust our staffing if that was occurring really early in the morning since we don\'t have very many techs on from midnight until 5:30 AM. If too many labs came in before 5:30 AM we might need to hire more techs.'
                },
                {
                    id: 'phlebotomist-001',
                    name: 'Jennifer Williams',
                    occupation: 'Phlebotomist',
                    attitude: 'Smart, competent and busy. They have a lot to do and are a little annoyed that night team doesn\'t help out more. That being said, they are professional, want to see improvement and clearly understand the system.',
                    knowledge: 'All blood draws and IVs are done by a phlebotomy team and not by bedside nurses per our union contract. Phlebotomy staffing is split into two shifts, night and day shift, both of which are 12-hour shifts that begin at either 5:00 AM or 5:00 PM. Five phlebotomists are assigned to the night shift, ten are assigned to day shift. We\'re a bit short-staffed right now as four phlebotomists recently retired and their spots are still empty. In the past 6 months, on an average morning, we draw blood from 150 patients each morning. Morning labs are ordered by the provider for the "0530 draw". This is just an average time of when blood is drawn, obviously not every lab is done right at 0530. When day phlebotomy team arrives at 5:00 AM, we get our assignment, prep the lab draw cart which takes about 15-20 minutes in the supply room and head off to begin collections by 5:30 AM. We each draw our list of patients which typically is done by ward. We do get interrupted sometimes by Stat draws. We have to stop what we are doing and go do the stat draw. This causes quite a bit of interruption to our workflow and my nurse colleagues tell me it\'s just because the provider forgot to order labs. I wished they realized how much this interrupts our mornings and delays everything. The night phlebotomy team is on until 5:00am and lab draws are supposed to start at 4:00 AM. This means there is an hour of night shift they can help-out. However, it\'s poorly managed and there are no real rules. Typically, the night shift phlebotomists each choose five patients at their own discretion on which to draw labs. The night shift phlebotomists cherry pick the easy patients. You know, the patients with a central line or something. They also "count" an attempted draw, even if they were not successful. They may only end up getting blood from 3 patients with central lines and have 2 "attempts" and they are done. It ultimately means they provide almost no help with the morning draw volume, it\'s all left to day team.'    
                },
                {
                    id: 'phlebotomy-manager-001',
                    name: 'Bob Thompson',
                    occupation: 'Phlebotomy Manager',
                    attitude: 'This character is supposed to be a grumpy curmudgeon. He is 6 months from retirement and not interested in helping if he doesn\'t absolutely have to. He clearly hasn\'t worked to fix any problems as the manager and isn\'t interested in starting unless he must.',
                    knowledge: 'Morale is pretty low. I think staffing is the major issue. We are chronically short staffed. We had 4 people retire in the past few months. Unfortunately, it takes so long to hire new staff there is often a big delay between staff leaving and the new people starting. Also, our staffing doesn\'t align with the needs of the hospital. I have no clue why shifts start at 5:00 AM which is right in the middle of the AM draw and the busiest time of day for us. Furthermore, because the shifts are 12-hours long we end up having too few people in the morning for the bulk draw when we need them and too many people in the afternoon when things slow down. But changing people\'s schedules pretty much takes an act of congress. Once you are hired the union protections mandate that we give them the shift they were hired for. Maybe we should hire the 4 new replacements for different shifts since the union contract only applies after you are hired... Yes, an even bigger issue is we don\'t have any limits on people overlapping their vacation time. Some folks will schedule their vacation days to align because they know the workload will be higher when someone else if off. One day last month we only had 4 phlebotomist show up for day shift, out of 10!...for the entire hospital. I thought about trying to change the vacation policy but working with the union takes WAY to long. I just gave up. Look, I\'ll be honest. I\'m not a people person. I\'m 6 months from retirement. While I appreciate and welcome the help to try to improve the situation, I\'m not sure it\'s going to do much good. I recently did observations of an entire mornings blood draws and recorded how the phlebotomists spend their time. With so many patients to draw, little delays here and there add up quickly, like having to place an IV, gown up, draw routine blood cultures or the inevitable "stat" lab which requires they drop what they are doing on the AM bulk draw and deal with the stat lab instead. I\'m almost certain most of our early morning stat labs are because one of the docs forgot to order it for the bulk lab draw so they just order it stat instead. It\'s amazing how many 6:30 or 7:00 AM stat labs we get on patients who have no other labs ordered. Very suspicious... and it totally disrupts the bulk draw work-flow because they have to run off and take care of the stat draw and it delays everything else.'
                }
            ]
        };

        // Global state management for single chat interface
        let state = {
            currentScenario: null,
            staffMembers: [],
            currentStaff: null,
            allMessages: [], // All messages in chronological order with staff identification
            isLoading: false,
            apiKey: null, // Store API key from URL
            staffColors: {} // Store color assignments for staff members
        };

        // Available colors for staff members (muted but distinguishable)
        const STAFF_COLORS = ['blue', 'green', 'purple', 'orange', 'pink', 'teal', 'yellow', 'red'];

        // Initialize scenario with hardcoded data
        function initializeScenario() {
            state.currentScenario = SCENARIO_CONFIG;
            state.staffMembers = [...SCENARIO_CONFIG.characters];
            state.currentStaff = SCENARIO_CONFIG.characters[0] || null; // Default to first staff member
            
            // Assign colors to staff members
            assignStaffColors(state.staffMembers);
            
            // Start with empty conversations (cleared on page reload)
            state.allMessages = [];
            
            // Clear any old conversation data for this scenario
            const conversationKey = `qi-conversations-${SCENARIO_CONFIG.id}`;
            localStorage.removeItem(conversationKey);
            
            // Set scenario info in the header
            const nameEl = document.getElementById('current-scenario-name');
            const descEl = document.getElementById('current-scenario-description');
            nameEl.textContent = SCENARIO_CONFIG.name;
            descEl.textContent = SCENARIO_CONFIG.description;
        }

        // Default scenarios data removed - using SCENARIO_CONFIG above

        // Utility functions removed - generateId moved to educator portal

        // Assign colors to staff members
        function assignStaffColors(staffMembers) {
            const colorKey = `qi-staff-colors-${state.currentScenario?.id}`;
            let savedColors = loadFromStorage(colorKey, {});
            
            staffMembers.forEach((staff, index) => {
                if (!savedColors[staff.id]) {
                    savedColors[staff.id] = STAFF_COLORS[index % STAFF_COLORS.length];
                }
            });
            
            state.staffColors = savedColors;
            saveToStorage(colorKey, savedColors);
        }

        // Get staff color by ID
        function getStaffColor(staffId) {
            return state.staffColors[staffId] || 'blue';
        }

        // Local Storage functions
        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadFromStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return defaultValue;
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', async () => {
            // Set viewport height CSS variable for mobile (fixes keyboard push issue)
            const setViewportHeight = () => {
                // First we get the viewport height and we multiple it by 1% to get a value for a vh unit
                let vh = window.innerHeight * 0.01;
                // Then we set the value in the --vh custom property to the root of the document
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // Additional iOS fix - ensure body and main have correct height
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    // Use visualViewport if available (better for iOS)
                    if (window.visualViewport) {
                        vh = window.visualViewport.height * 0.01;
                        document.documentElement.style.setProperty('--vh', `${vh}px`);
                    }
                    
                    // Force reflow for iOS
                    document.body.style.height = `${window.innerHeight}px`;
                    setTimeout(() => {
                        document.body.style.height = '';
                    }, 100);
                }
            };
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', setViewportHeight);
            
            // iOS specific - handle visual viewport changes
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', setViewportHeight);
                window.visualViewport.addEventListener('scroll', (e) => {
                    // Prevent viewport from scrolling when keyboard appears
                    if (e.target.offsetTop !== 0) {
                        window.scrollTo(0, 0);
                    }
                });
            }
        
            // Extract API key from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            state.apiKey = urlParams.get('apikey');
            
            if (!state.apiKey) {
                showAlert('API Key required. Please add ?apikey=your_openai_key to the URL', 'error');
            }
            
            // Initialize scenario with hardcoded data
            initializeScenario();
            
            // Mobile-specific optimizations
            if (isMobile()) {
                initializeMobileFeatures();
            }
            
            initializeInterface();
            console.log('Quality Improvement Training - Single Chat Interface initialized');
        });
        
        // Check if device is mobile
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                   || window.innerWidth <= 768;
        }
        
        // Initialize mobile-specific features
        function initializeMobileFeatures() {
            // Prevent pull-to-refresh and body scrolling on mobile
            document.body.style.width = '100%';
            document.body.style.overflow = 'hidden';
            document.body.style.webkitOverflowScrolling = 'touch';
            
            // iOS specific fixes
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                // Prevent elastic bounce on iOS
                document.body.addEventListener('touchmove', function(e) {
                    if (!e.target.closest('.chat-messages') && !e.target.closest('.staff-panel')) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // Fix for iOS keyboard pushing content up
                const fixIOSViewport = () => {
                    const activeElement = document.activeElement;
                    if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                        // Input is focused, ensure chat container is properly sized
                        setTimeout(() => {
                            const chatInterface = document.querySelector('.chat-interface');
                            if (chatInterface && window.visualViewport) {
                                chatInterface.style.height = `${window.visualViewport.height}px`;
                            }
                        }, 300);
                    }
                };
                
                document.addEventListener('focusin', fixIOSViewport);
                document.addEventListener('focusout', () => {
                    // Reset height when keyboard is hidden
                    setTimeout(() => {
                        const chatInterface = document.querySelector('.chat-interface');
                        if (chatInterface) {
                            chatInterface.style.height = '';
                        }
                        window.scrollTo(0, 0);
                    }, 300);
                });
            }
            
            // Allow scrolling only in specific areas
            // document.body.addEventListener('touchmove', function(e) {
            //     if (e.target.closest('.chat-messages') || e.target.closest('.staff-panel')) {
            //         return; // Allow scrolling in these areas
            //     }
            //     e.preventDefault(); // Prevent scrolling elsewhere
            // }, { passive: false });
            
            // Handle virtual keyboard
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('focus', function() {
                    // Ensure chat input is visible when keyboard appears
                    setTimeout(() => {
                        const chatInputContainer = document.querySelector('.chat-input-container');
                        if (chatInputContainer) {
                            chatInputContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                        
                        // Scroll to bottom of messages
                        const chatMessages = document.getElementById('chat-messages');
                        if (chatMessages && state.allMessages.length > 0) {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }, 300);
                });
                
                // Auto-resize input on mobile
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 80) + 'px';
                    // Always scroll chat-messages to bottom when input resizes
                    const chatMessages = document.getElementById('chat-messages');
                    if (chatMessages) {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                });
            }
            
            // Improve touch responsiveness
            document.addEventListener('touchstart', function() {}, { passive: true });
            
            // Handle viewport changes (keyboard show/hide)
            // if (window.visualViewport) {
            //     window.visualViewport.addEventListener('resize', () => {
            //         const chatInterface = document.querySelector('.chat-interface');
            //         if (chatInterface && window.visualViewport) {
            //             // Adjust the interface height based on visible viewport
            //             const viewportHeight = window.visualViewport.height;
            //             chatInterface.style.height = `${viewportHeight}px`;
            //         }
            //     });
            // }
        }

        // Scenario loading functions removed - using hardcoded SCENARIO_CONFIG

        // Render staff list
        function renderStaffList() {
            const staffList = document.getElementById('staff-list');
            
            if (!state.currentScenario || state.staffMembers.length === 0) {
                staffList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No staff available</h3>
                        <p>Please select a scenario with staff members</p>
                    </div>
                `;
                return;
            }
            
            staffList.innerHTML = state.staffMembers.map(staff => `
                <div class="staff-item ${state.currentStaff?.id === staff.id ? 'selected' : ''}" 
                     data-color="${getStaffColor(staff.id)}"
                     onclick="selectStaff('${staff.id}')">
                    <div class="staff-role">${staff.occupation}</div>
                </div>
            `).join('');
        }

        // Select a staff member
        function selectStaff(staffId) {
            const staff = state.staffMembers.find(s => s.id === staffId);
            if (!staff) return;
            
            state.currentStaff = staff;
            renderStaffList(); // Update selection
            renderChatArea(); // Update chat header and enable input
        }

        // Render chat area
        function renderChatArea() {
            const chatHeader = document.getElementById('chat-header');
            const chatMessages = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (!state.currentStaff) {
                chatHeader.style.display = 'block';
                chatHeader.innerHTML = '<span>Select a role to begin interview</span>';
                messageInput.disabled = true;
                sendBtn.disabled = true;
                
                if (state.allMessages.length === 0) {
                    chatMessages.innerHTML = `
                        <div class="chat-placeholder">
                            <i class="fas fa-comments"></i>
                            <p>Select a role from the panel to start the interview</p>
                        </div>
                    `;
                } else {
                    renderAllMessages();
                }
            } else {
                // Only show header if no messages have been sent yet
                if (state.allMessages.length === 0) {
                    chatHeader.style.display = 'block';
                    chatHeader.innerHTML = `<span>There have been delays with morning labs not being drawn and reported in a timely manner. Interview the employees, and when you are done interviewing, be sure to download the transcript. You can change who you are interviewing by selecting their title from the choices. You can switch as many times as needed to gather the relevant information. The physician is ready to be interviewed, or you may choose a different person and begin.</span>`;
                } else {
                    // Hide the header completely after first message
                    chatHeader.style.display = 'none';
                    chatHeader.style.position = 'absolute';
                }
                messageInput.disabled = false;
                sendBtn.disabled = false;
                renderAllMessages();
            }
        }

        // Render all messages in chronological order - ENHANCED FOR SCROLLING
        function renderAllMessages() {
            const chatMessages = document.getElementById('chat-messages');
            
            if (state.allMessages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="chat-placeholder">
                        <i class="fas fa-comments"></i>
                        <p>Start the conversation by asking a question</p>
                    </div>
                `;
                return;
            }
            
            let html = state.allMessages.map(message => {
                const staffRole = message.staffRole || message.staffName || 'Unknown Role';
                const staffColor = message.staffId ? getStaffColor(message.staffId) : 'blue';
                const staffTag = message.role === 'assistant' ? 
                    `<div class="message-staff-tag">${staffRole}</div>` : '';
                
                return `
                    <div class="chat-message ${message.role}" data-staff-color="${staffColor}">
                        ${staffTag}
                        ${message.content}
                    </div>
                `;
            }).join('');
            
            if (state.isLoading) {
                const currentStaffColor = state.currentStaff ? getStaffColor(state.currentStaff.id) : 'blue';
                html += `
                    <div class="chat-message assistant" data-staff-color="${currentStaffColor}">
                        <div class="message-staff-tag">${state.currentStaff?.occupation || 'Staff'}</div>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                        <span style="margin-left: 8px; color: #718096;">Typing...</span>
                    </div>
                `;
            }
            
            chatMessages.innerHTML = html;
            
            // Auto-scroll to bottom with smooth behavior
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }

        // Handle chat input key press
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Send message
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message || !state.currentStaff || state.isLoading || !state.apiKey) return;
            
            // Add user message to all messages
            const userMessage = {
                role: 'user',
                content: message,
                staffId: state.currentStaff.id,
                staffName: state.currentStaff.name,
                staffRole: state.currentStaff.occupation,
                timestamp: new Date().toISOString()
            };
            
            state.allMessages.push(userMessage);
            messageInput.value = '';
            state.isLoading = true;
            
            renderAllMessages();
            
            // Save to localStorage
            const conversationKey = `qi-conversations-${state.currentScenario.id}`;
            saveToStorage(conversationKey, state.allMessages);
            
            try {
                // Call OpenAI API directly
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4.1-mini',
                        messages: [
                            {
                                role: 'system',
                                content: `You are ${state.currentStaff.name}, a ${state.currentStaff.occupation} in a hospital quality improvement training simulation. 

Your attitude and personality:
${state.currentStaff.attitude}

Your knowledge and what you can reveal:
${state.currentStaff.knowledge}

IMPORTANT RULES:
- Stay strictly in character as ${state.currentStaff.name} with the attitude described above
- Only reveal information that is explicitly in your knowledge section above
- BE REALISTIC: Don't volunteer large amounts of information unless specifically asked detailed questions
- Answer only what is directly asked - don't elaborate beyond the specific question
- Make the resident work for information by requiring follow-up questions for details
- If asked a general question, give a brief, surface-level response
- Require specific, targeted questions to reveal deeper insights and data
- Act like a real busy hospital employee who gives short answers unless pressed for details
- Don't reveal information you don't have or make up new facts about processes or issues
- If asked about something not in your knowledge, say you don't know or direct them to ask another staff member
- Keep initial responses brief (1-2 sentences) unless asked for specifics
- Make residents ask "why" and "how" and "when" to get the full picture
- Remember to consistently portray your described attitude and personality
- Maintain your personality and communication style throughout the conversation
- You can create mundane small talk consistent with your personality, but nothing case-relevant beyond your knowledge
- Respond naturally as if being interviewed by a resident about quality improvement issues
- Interviews should be 2-4 minutes, so be somewhat concise but thorough when sharing your knowledge`
                            },
                            { role: 'user', content: message }
                        ],
                        max_tokens: 1500,
                        temperature: 0.7
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const aiMessage = {
                        role: 'assistant',
                        content: data.choices[0].message.content,
                        staffId: state.currentStaff.id,
                        staffName: state.currentStaff.name,
                        staffRole: state.currentStaff.occupation,
                        timestamp: new Date().toISOString()
                    };
                    state.allMessages.push(aiMessage);
                } else {
                    const errorMessage = {
                        role: 'assistant',
                        content: 'Error: ' + (data.error?.message || 'Failed to get response'),
                        staffId: state.currentStaff.id,
                        staffName: state.currentStaff.name,
                        staffRole: state.currentStaff.occupation,
                        timestamp: new Date().toISOString()
                    };
                    state.allMessages.push(errorMessage);
                }
            } catch (error) {
                console.error('OpenAI API error:', error);
                const errorMessage = {
                    role: 'assistant',
                    content: 'Error: Failed to send message. Please check your API key and internet connection.',
                    staffId: state.currentStaff.id,
                    staffName: state.currentStaff.name,
                    staffRole: state.currentStaff.occupation,
                    timestamp: new Date().toISOString()
                };
                state.allMessages.push(errorMessage);
            }
            
            state.isLoading = false;
            renderAllMessages();
            renderChatArea(); // Update header after sending message
            
            // Save updated conversations to localStorage
            saveToStorage(conversationKey, state.allMessages);
        }

        // Scenario selector functions removed - not needed with separate folders

        // Clear all conversations
        // Clear conversations function removed - handled by page reload

        // Initialize interface
        function initializeInterface() {
            renderStaffList();
            renderChatArea();
            
            // Ensure chat input is visible on mobile
            if (isMobile()) {
                const chatInputContainer = document.querySelector('.chat-input-container');
                if (chatInputContainer) {
                    // Make sure the input container is in view
                    const rect = chatInputContainer.getBoundingClientRect();
                    if (rect.bottom > window.innerHeight) {
                        // If input is below viewport, adjust layout
                        const chatMessages = document.getElementById('chat-messages');
                        // if (chatMessages) {
                        //     chatMessages.style.maxHeight = `${window.innerHeight - rect.height - 200}px`;
                        // }
                    }
                }
            }
        }

        // Modal functions
        function showModal(title, content, footer = '') {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div data-modal data-active>
                    <div>
                        <header>
                            <h3>${title}</h3>
                        </header>
                        <div class="body">
                            ${content}
                        </div>
                        ${footer ? `<footer>${footer}</footer>` : ''}
                    </div>
                </div>
            `;
        }

        function hideModal() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
        }

        // Alert system
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);
            
            // Animate in
            setTimeout(() => {
                alert.classList.add('show');
            }, 100);
            
            // Remove after delay
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }, 3000);
        }

        // Generate and download transcript as RTF
        function downloadTranscriptRTF() {
            if (state.allMessages.length === 0) {
                showAlert('No conversation to export', 'error');
                return;
            }
            
            // Generate RTF content with proper formatting
            let rtfContent = '{\\rtf1\\ansi\\deff0 {\\fonttbl {\\f0 Times New Roman;}}';
            rtfContent += '\\f0\\fs24 '; // Set font and size
            
            // Add title
            rtfContent += '\\b Interview Transcript\\b0\\par\\par';
            
            // Add scenario information
            if (state.currentScenario) {
                rtfContent += `\\b Scenario:\\b0 ${state.currentScenario.name}\\par`;
                rtfContent += `\\b Date:\\b0 ${new Date().toLocaleDateString()}\\par\\par`;
            }
            
            // Process messages and format as script
            state.allMessages.forEach(message => {
                const speaker = message.role === 'user' ? 'User' : message.staffRole || message.staffName || 'Staff';
                const cleanContent = message.content
                    .replace(/\\/g, '\\\\')  // Escape backslashes
                    .replace(/\{/g, '\\{')   // Escape braces
                    .replace(/\}/g, '\\}')   // Escape braces
                    .replace(/\n/g, '\\par'); // Convert newlines to RTF paragraph breaks
                
                rtfContent += `\\b ${speaker}: \\b0${cleanContent}\\par\\par`;
            });
            
            rtfContent += '}'; // Close RTF document
            
            // Create and download the file
            const blob = new Blob([rtfContent], { type: 'application/rtf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transcript_${new Date().toISOString().slice(0, 10)}.rtf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('Transcript downloaded successfully!', 'success');
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.hasAttribute('data-modal')) {
                hideModal();
            }
        });
        
        // Handle orientation change and window resize
        let resizeTimer;
        function handleResize() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                // Adjust chat messages height on resize
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages && state.allMessages.length > 0) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                // Re-initialize mobile features if needed
                if (isMobile() && !document.body.hasAttribute('data-mobile-initialized')) {
                    initializeMobileFeatures();
                    document.body.setAttribute('data-mobile-initialized', 'true');
                }
            }, 250);
        }
        
        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', handleResize);
    </script>
</body>
</html>