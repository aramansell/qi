<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Quality Improvement Training</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">

</head>
<body>
    <main>
        <!-- Single Chat Interface -->
        <div class="chat-interface">
            <!-- Scenario Selection Header -->
            <div class="scenario-header">
                <div class="scenario-info">
                    
                    <h2 id="current-scenario-name">Select a Scenario</h2>
                    <p id="current-scenario-description">Choose a training scenario to begin interviewing staff</p>
                    
                </div>
            </div>

            <!-- Main Chat Container -->
            <div class="main-chat-container">
                <!-- Staff Selection Panel -->
                <div class="staff-panel">
                    <h3><i class="fas fa-users"></i> Available Roles</h3>
                    <div id="staff-list">
                        <!-- Staff members will be populated here -->
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="chat-area">
                    <div class="chat-header" id="chat-header">
                        <span>Select a role to begin interview</span>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-placeholder">
                            <i class="fas fa-comments"></i>
                            <p>Select a role from the panel to start the interview</p>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <div class="chat-input-group">
                            <input type="text" class="chat-input" id="message-input" 
                                   placeholder="Ask about processes and quality issues..."
                                   onkeypress="handleChatKeyPress(event)"
                                   disabled>
                            <button data-primary onclick="sendMessage()" id="send-btn" disabled>
                                <i class="fas fa-paper-plane"></i>
                                <span>Send</span>
                            </button>
                            <button data-danger onclick="downloadTranscriptRTF()" id="download-transcript-btn" title="Download Transcript">
                                <i class="fas fa-download"></i>
                                <span class="download-text">Download</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modal-container"></div>

    <script>
        // ========================================
        // SCENARIO CONFIGURATION 
        // ========================================
        // Update this section for each scenario
        const SCENARIO_CONFIG = {
                  "id": "scenario_c",
                  "name": "scenario_c",
                  "description": "Please investigate stakeholders perspective on consult recommendation timeliness and what factors may be contributing to delays.",
                  "characters": [
                            {
                                      "id": "me84rrnjamg3w570d3",
                                      "name": "Sara",
                                      "occupation": "Hospitalist",
                                      "attitude": "No nonsense, succinct, they understand the system and directly and clearly answer questions.",
                                      "knowledge": "You are a hospitalist physician who is no-nonsense, succinct, and understands the healthcare system well. You directly and clearly answer questions without unnecessary elaboration. You're frustrated with long length of stays at your hospital and see consult timing as a major contributing factor, understanding this is part of a bigger systemic problem the hospital is trying to address. Your key information includes that your hospital has one of the longest overall lengths of stay for VAs in the country, and there's a major initiative examining why length of stay is so long with improving consult timeliness being just one part of this bigger picture. Your hospitalist group identified consult recommendation timing as a major contributing factor to extended stays. The hospital doesn't currently have a policy regarding consult timing, and historically there was no way to track consult timing because you couldn't timestamp when consults were placed. Now you can at least track time from consult order to note being signed, but the culture around timing is already established where most consultants don't give recommendations until end of business day, often the following day. Waiting for consultant recommendations delays everything including patient discharges, procedures, and medication starts. You might waste an entire day waiting to start treatment until you hear from a consultant, and this delay in recommendations directly contributes to longer lengths of stay. You can discuss how the lack of tracking historically has led to a lax culture around consult timeliness, and how even small delays cascade into significant impacts on patient flow and care.",
                                      "sample_dialogue": `Interviewer Question 1: Can you tell me more about the project for improving timing of consultant recommendations on inpatient medicine wards?
Hospitalist Response 1: Well I believe the project is being pushed because the hospital is too full and our length of stay is way too long. We have one of the longest overall lengths of stays for VAs around the country. I believe we are trying to tackle this from multiple fronts and one of them is improving our consult recommendation timing. Which was identified by our hospitalist group as one of the major contributing factors.

Interviewer Question 2: Can you tell us why you believe consultants on inpatient wards are not getting back to you fast enough?
Hospitalist Response 2: Well, our hospital doesn’t have a policy regarding timing of consults. Historically, we had no way to track this consult timing because we couldn’t “timestamp” when a consult was placed. Now we can at least track time from consult order to note being signed. However, the culture is already set in place and I’d say most consultants don’t give us recommendations until end of business day and pretty often it’s the following day.  

Interviewer Question 3 Please tell me why does timing of consultants answering questions matters to your work?
Hospitalist Response 3: If we must wait all day or even into a second day to hear and implement our consultant recommendations it just delays everything. I patient might not be able to discharge home that day, or their procedure gets delayed, or we simply waste an entire day waiting to start a medication until we hear from a consultant.`
                            },
                            {
                                      "id": "me84rrnj0315lqlsz80s",
                                      "name": "Grace",
                                      "occupation": "GI Fellow",
                                      "attitude": "Smart, competent and busy. They are professional, want to see improvement and clearly understand the system.",
                                      "knowledge": "You are a smart, competent, and busy GI fellow who is professional, wants to see improvement, and clearly understands the healthcare system. You have insight into the workflow challenges and understand the consult process well while dealing with significant workflow and resource constraints. The consult workflow involves the primary team paging for verbal discussion, then a consult order placed with contact name, followed by chart review, seeing the patient, staffing with attending, providing verbal recommendations, and finally signing the note. There are no clear timing guidelines at the VA unlike other hospitals like OHSU which has specific timeframes, though in a perfect world non-stat consults could have recommendations back by mid-afternoon if placed early enough. Major delay factors include attendings scheduled for clinic or imaging while on inpatient consult service, back-to-back procedures preventing timely patient visits, residents getting jeopardized or pulled away from busy services like GI and cards, and late consults from teams especially for patients who've been there for days. Teams don't recognize how disruptive afternoon consults are when not urgent. You absolutely rely on residents to get your day done, especially on busy procedure days, and when it's just you and the attending with no resident available, the entire process gets delayed. Late consults often get pushed to the following day. You can discuss the ripple effects of scheduling conflicts, the importance of having adequate staffing, and how timing of consult requests impacts your ability to respond promptly.",
                                      "sample_dialogue": `Interviewer Question 1: Thank you for meeting. We are doing a QI project on consult timing, and I was hoping you could explain to me how the consult process is done in general for medicine consults?
GI Fellow Response 1: Sure, so when the primary team identifies they have a consult question they are supposed to page us for a verbal discussion and provide their consult question. During/immediately after that discussion they are supposed to place a consult order which includes the name of the individual they spoke to on the phone. After we get the consult, we do our usual chart review, see the patient and then staff. Assuming the patient is in the room and available to be seen. If there is a resident involved they may do this separate from the fellow. Once we have collected all this information we typically staff with our attending when they are available. Once the attending see’s the patient and we make a final plan usually myself or the resident will call the primary team to provide our recommendations verbally and we will sign our consult note. 

Interviewer Question 2: How long do you think consultants should have to provide recommendations?
GI Fellow Response 2: Well I guess for most general, non-stat, consults in a perfect world we could have recommendations back by mid-afternoon depending on when the consult was placed. I know at OHSU if the consult is before 2pm we have to have them back by end of business day and if after 2pm it has to be back by noon the next day. I don’t think we have any actual recommended timing “guidelines” at the VA, not that anyone has ever told me. 

Interviewer Question 3: Where do you think delays occur? 
GI Fellow Response 3: Well, delays occur for lots of reasons. As you probably know, some service lines still schedule their attendings with clinic or imaging when they are on inpatient consult service, so fellows have to wait to  staff with them. Also, we are sometimes in back to back procedures and physically can’t go see a consult for quite a while. This is especially problematic if we don’t have a resident on the service that day. Sometimes they get jeopardized and then it’s just me and the attending and no one is available to start the process of doing the consult until all our procedures are done. I really wish residents didn’t get jeopardized from the busier inpatient consult services like GI and cards where we absolutely rely on residents to get our day done. Finally, some teams give us late consults which makes things hard. Especially if the patient has been there for days and they call us after lunch. We are trying to wrap up other consults, staff and honestly I usually push these to the following day. Teams don’t seem to recognize how disruptive these afternoon consults are if they are not actually urgent.`
                            },
                            {
                                      "id": "me84rrnjeh8kqsz67ik",
                                      "name": "Fred",
                                      "occupation": "Oncology Attending",
                                      "attitude": "Very busy and pretty short in their responses but not rude. They really feel like it isn’t their problem and something they shouldn’t be burdened with.",
                                      "knowledge": "You are very busy and pretty short in your responses, but not rude. You feel like consult timing complaints aren't really your problem and are something you shouldn't be burdened with given your constraints. You're frustrated because people want faster consults but don't understand your scheduling constraints, feeling the problem lies with administrative decisions rather than physician performance. You don't have enough protected time to do inpatient consults and still must work at least half a day of clinic when on the inpatient consult service, sometimes more. It's literally impossible to staff consults sooner because you're in clinic all morning and can't be in two places at once. Your ideal scenario would be when on inpatient consults, that should be all you do for the week with no clinic patients and no urgent outpatient needs. Patient volume is increasing while expectations for speed are also increasing. Hospital administrators need to change scheduling so you're not double-booked for clinic and inpatient consults, and if administrators want faster consults, they need to stop forcing you to see clinic patients during consult weeks. You can express frustration about unrealistic expectations and the need for administrative support to make meaningful changes. You understand the hospitalists' needs but feel constrained by the current system.",
                                      "sample_dialogue": `Interviewer Question 1: We’ve received several complaints that consultants are not providing recommendations to the primary team in a timely manner. What is your perspective on this?
Oncology Attending Response 1: I get that the hospitalists are slammed and really want consults back quick. But you have to understand, we don’t have enough protected time to do inpatient consults. I still must work at least a half day of clinic when I’m on the inpatient consult service, sometimes more. It’s literally impossible for me to staff consults any sooner than I do because I am in clinic all morning. If they want consults to be faster tell the hospital administrators to stop forcing us to also see patients in clinic and I will happily see consults sooner!

Interviewer Question 2: What would be the ideal scenario?
Oncology Response 2: The idea scenario is that when I’m on inpatient consults that is all I do for the week. I don’t see clinic patients, I don’t have spots open for “urgent outpatient needs.” I can’t be in two places at once. Our volume is just going up and they want everything done faster. It just isn’t possible.`
                            },
                            {
                                      "id": "me84rrnjin7ii2t6rod",
                                      "name": "George",
                                      "occupation": "Hospital Administrator",
                                      "attitude": "This character is supposed to be a grumpy curmudgeon. He is 6 months from retirement and not interested in helping if he doesn’t absolutely have to. He clearly hasn’t worked to fix any problems as an administrator and isn’t interested in starting unless he must.",
                                      "knowledge": "You are a grumpy curmudgeon who is 6 months from retirement and not interested in helping unless you absolutely have to. You clearly haven't worked to fix problems as an administrator and aren't interested in starting unless forced to. You're reluctant to make changes, see multiple barriers to improvement, and are more focused on surviving until retirement than solving complex problems. You surveyed consult divisions and found that the most common response was that consults aren't actually delayed because they provide verbal recommendations, but metrics based on note entry time are inaccurate. The second most common issue was waiting to staff due to attending unavailability, and third was being in procedures. You suggested consultants should drop brief notes to document verbal recommendations. Making changes across multiple groups and divisions is extremely difficult because everyone has different needs. Allowing attendings to focus only on inpatient services creates other problems including clinic backlog getting worse, needing to hire more specialists which is very time-consuming, and dealing with different divisional needs and conflicts. You're not a people person and don't want to deal with coordinating between different groups. Your boss is pressuring you, but you're not optimistic about solutions, and you're 6 months from retirement and frankly don't want to deal with any of this. You can discuss the complexity of healthcare administration, competing priorities, resource constraints, and the challenges of implementing system-wide changes. You're pessimistic but not completely obstructionist and will do what you must but won't go above and beyond.",
                                      "sample_dialogue": `Interviewer Question 1: There is a push to try and make consult recommendations more timely on medicine wards. Could you tell me more about where you think the problem with consult timeliness is?
Hospital Administrator Response 1: One of the biggest issues we’ve had is not knowing where the delays are taking place. To fix this, I surveyed all our various consult divisions, attendings and fellows, and asked them to list the top 3 things that lead to consult delays. We found the most common thing attendings and fellows said was that consults are not delayed, they just provide recommendations verbally and our metric based off the note entry time is inaccurate. My response to this is they should drop a brief note so its documented somewhere, otherwise there is no way to prove this is happening. The second most common is waiting to staff due to attending lack of availability and thirdly being in a procedure. I guess we could try and target one of these areas since my boss is breathing down my neck but I’m not sure it’s going to do much good.

Interviewer Question 2: It seems like there are a lot of barriers you are facing. Have you identified an area you think will work best to fix consult timing issues?
Hospital Administrator Response 2: Do you know how hard it is going to be to talk with all these division heads to come up with a process that everyone will agree with!? Plus we already have a HUGE backlog in clinic and giving  people more time to complete inpatient consults will just make that worse! We will have to hire more specialists! God knows how long that will take. 

Interviewer Question 3: That seems like a lot.
Hospital Administrator Response 3: Look, I’ll be honest. I’m not a people person. I’m 6 months from retirement. I frankly don’t want to deal with any of this.`
                            }
                  ]
        };

        // Global state management for single chat interface
        let state = {
            currentScenario: null,
            staffMembers: [],
            currentStaff: null,
            allMessages: [], // All messages in chronological order with staff identification
            isLoading: false,
            apiKey: null, // Store API key from URL
            staffColors: {} // Store color assignments for staff members
        };

        // Available colors for staff members (muted but distinguishable)
        const STAFF_COLORS = ['blue', 'green', 'purple', 'orange', 'pink', 'teal', 'yellow', 'red'];

        // Initialize scenario with hardcoded data
        function initializeScenario() {
            state.currentScenario = SCENARIO_CONFIG;
            state.staffMembers = [...SCENARIO_CONFIG.characters];
            state.currentStaff = SCENARIO_CONFIG.characters[0] || null; // Default to first staff member
            
            // Assign colors to staff members
            assignStaffColors(state.staffMembers);
            
            // Start with empty conversations (cleared on page reload)
            state.allMessages = [];
            
            // Clear any old conversation data for this scenario
            const conversationKey = `qi-conversations-${SCENARIO_CONFIG.id}`;
            localStorage.removeItem(conversationKey);
            
            // Set scenario info in the header
            const nameEl = document.getElementById('current-scenario-name');
            const descEl = document.getElementById('current-scenario-description');
            nameEl.textContent = SCENARIO_CONFIG.name;
            descEl.textContent = SCENARIO_CONFIG.description;
        }

        // Default scenarios data removed - using SCENARIO_CONFIG above

        // Utility functions removed - generateId moved to educator portal

        // Assign colors to staff members
        function assignStaffColors(staffMembers) {
            const colorKey = `qi-staff-colors-${state.currentScenario?.id}`;
            let savedColors = loadFromStorage(colorKey, {});
            
            staffMembers.forEach((staff, index) => {
                if (!savedColors[staff.id]) {
                    savedColors[staff.id] = STAFF_COLORS[index % STAFF_COLORS.length];
                }
            });
            
            state.staffColors = savedColors;
            saveToStorage(colorKey, savedColors);
        }

        // Get staff color by ID
        function getStaffColor(staffId) {
            return state.staffColors[staffId] || 'blue';
        }

        // Local Storage functions
        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadFromStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return defaultValue;
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', async () => {
            // Set viewport height CSS variable for mobile (fixes keyboard push issue)
            const setViewportHeight = () => {
                // First we get the viewport height and we multiple it by 1% to get a value for a vh unit
                let vh = window.innerHeight * 0.01;
                // Then we set the value in the --vh custom property to the root of the document
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // Additional iOS fix - ensure body and main have correct height
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    // Use visualViewport if available (better for iOS)
                    if (window.visualViewport) {
                        vh = window.visualViewport.height * 0.01;
                        document.documentElement.style.setProperty('--vh', `${vh}px`);
                    }
                    
                    // Force reflow for iOS
                    document.body.style.height = `${window.innerHeight}px`;
                    setTimeout(() => {
                        document.body.style.height = '';
                    }, 100);
                }
            };
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', setViewportHeight);
            
            // iOS specific - handle visual viewport changes
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', setViewportHeight);
                window.visualViewport.addEventListener('scroll', (e) => {
                    // Prevent viewport from scrolling when keyboard appears
                    if (e.target.offsetTop !== 0) {
                        window.scrollTo(0, 0);
                    }
                });
            }
        
            // Extract API key from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            state.apiKey = urlParams.get('apikey');
            
            if (!state.apiKey) {
                showAlert('API Key required. Please add ?apikey=your_openai_key to the URL', 'error');
            }
            
            // Initialize scenario with hardcoded data
            initializeScenario();
            
            // Mobile-specific optimizations
            if (isMobile()) {
                initializeMobileFeatures();
            }
            
            initializeInterface();
            console.log('Quality Improvement Training - Single Chat Interface initialized');
        });
        
        // Check if device is mobile
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                   || window.innerWidth <= 768;
        }
        
        // Initialize mobile-specific features
        function initializeMobileFeatures() {
            // Prevent pull-to-refresh and body scrolling on mobile
            document.body.style.width = '100%';
            document.body.style.overflow = 'hidden';
            document.body.style.webkitOverflowScrolling = 'touch';
            
            // iOS specific fixes
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                // Prevent elastic bounce on iOS
                document.body.addEventListener('touchmove', function(e) {
                    if (!e.target.closest('.chat-messages') && !e.target.closest('.staff-panel')) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // Fix for iOS keyboard pushing content up
                const fixIOSViewport = () => {
                    const activeElement = document.activeElement;
                    if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                        // Input is focused, ensure chat container is properly sized
                        setTimeout(() => {
                            const chatInterface = document.querySelector('.chat-interface');
                            if (chatInterface && window.visualViewport) {
                                chatInterface.style.height = `${window.visualViewport.height}px`;
                            }
                        }, 300);
                    }
                };
                
                document.addEventListener('focusin', fixIOSViewport);
                document.addEventListener('focusout', () => {
                    // Reset height when keyboard is hidden
                    setTimeout(() => {
                        const chatInterface = document.querySelector('.chat-interface');
                        if (chatInterface) {
                            chatInterface.style.height = '';
                        }
                        window.scrollTo(0, 0);
                    }, 300);
                });
            }
            
            // Allow scrolling only in specific areas
            // document.body.addEventListener('touchmove', function(e) {
            //     if (e.target.closest('.chat-messages') || e.target.closest('.staff-panel')) {
            //         return; // Allow scrolling in these areas
            //     }
            //     e.preventDefault(); // Prevent scrolling elsewhere
            // }, { passive: false });
            
            // Handle virtual keyboard
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('focus', function() {
                    // Ensure chat input is visible when keyboard appears
                    setTimeout(() => {
                        const chatInputContainer = document.querySelector('.chat-input-container');
                        if (chatInputContainer) {
                            chatInputContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                        
                        // Scroll to bottom of messages
                        const chatMessages = document.getElementById('chat-messages');
                        if (chatMessages && state.allMessages.length > 0) {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }, 300);
                });
                
                // Auto-resize input on mobile
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 80) + 'px';
                    // Always scroll chat-messages to bottom when input resizes
                    const chatMessages = document.getElementById('chat-messages');
                    if (chatMessages) {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                });
            }
            
            // Improve touch responsiveness
            document.addEventListener('touchstart', function() {}, { passive: true });
            
            // Handle viewport changes (keyboard show/hide)
            // if (window.visualViewport) {
            //     window.visualViewport.addEventListener('resize', () => {
            //         const chatInterface = document.querySelector('.chat-interface');
            //         if (chatInterface && window.visualViewport) {
            //             // Adjust the interface height based on visible viewport
            //             const viewportHeight = window.visualViewport.height;
            //             chatInterface.style.height = `${viewportHeight}px`;
            //         }
            //     });
            // }
        }

        // Scenario loading functions removed - using hardcoded SCENARIO_CONFIG

        // Render staff list
        function renderStaffList() {
            const staffList = document.getElementById('staff-list');
            
            if (!state.currentScenario || state.staffMembers.length === 0) {
                staffList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No staff available</h3>
                        <p>Please select a scenario with staff members</p>
                    </div>
                `;
                return;
            }
            
            staffList.innerHTML = state.staffMembers.map(staff => `
                <div class="staff-item ${state.currentStaff?.id === staff.id ? 'selected' : ''}" 
                     data-color="${getStaffColor(staff.id)}"
                     onclick="selectStaff('${staff.id}')">
                    <div class="staff-role">${staff.occupation}</div>
                </div>
            `).join('');
        }

        // Select a staff member
        function selectStaff(staffId) {
            const staff = state.staffMembers.find(s => s.id === staffId);
            if (!staff) return;
            
            state.currentStaff = staff;
            renderStaffList(); // Update selection
            renderChatArea(); // Update chat header and enable input
        }

        // Render chat area
        function renderChatArea() {
            const chatHeader = document.getElementById('chat-header');
            const chatMessages = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (!state.currentStaff) {
                chatHeader.style.display = 'block';
                chatHeader.innerHTML = '<span>Select a role to begin interview</span>';
                messageInput.disabled = true;
                sendBtn.disabled = true;
                
                if (state.allMessages.length === 0) {
                    chatMessages.innerHTML = `
                        <div class="chat-placeholder">
                            <i class="fas fa-comments"></i>
                            <p>Select a role from the panel to start the interview</p>
                        </div>
                    `;
                } else {
                    renderAllMessages();
                }
            } else {
                // Only show header if no messages have been sent yet
                if (state.allMessages.length === 0) {
                    chatHeader.style.display = 'block';
                    chatHeader.innerHTML = `<span>${SCENARIO_CONFIG.description} Interview the employees, and when you are done interviewing, be sure to download the transcript. You can change who you are interviewing by selecting their title from the choices. You can switch as many times as needed to gather the relevant information. The ${SCENARIO_CONFIG.characters[0].occupation.toLowerCase()} is ready to be interviewed, or you may choose a different person and begin.</span>`;
                } else {
                    // Hide the header completely after first message
                    chatHeader.style.display = 'none';
                    chatHeader.style.position = 'absolute';
                }
                messageInput.disabled = false;
                sendBtn.disabled = false;
                renderAllMessages();
            }
        }

        // Render all messages in chronological order - ENHANCED FOR SCROLLING
        function renderAllMessages() {
            const chatMessages = document.getElementById('chat-messages');
            
            if (state.allMessages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="chat-placeholder">
                        <i class="fas fa-comments"></i>
                        <p>Start the conversation by asking a question</p>
                    </div>
                `;
                return;
            }
            
            let html = state.allMessages.map(message => {
                const staffRole = message.staffRole || message.staffName || 'Unknown Role';
                const staffColor = message.staffId ? getStaffColor(message.staffId) : 'blue';
                const staffTag = message.role === 'assistant' ? 
                    `<div class="message-staff-tag">${staffRole}</div>` : '';
                
                return `
                    <div class="chat-message ${message.role}" data-staff-color="${staffColor}">
                        ${staffTag}
                        ${message.content}
                    </div>
                `;
            }).join('');
            
            if (state.isLoading) {
                const currentStaffColor = state.currentStaff ? getStaffColor(state.currentStaff.id) : 'blue';
                html += `
                    <div class="chat-message assistant" data-staff-color="${currentStaffColor}">
                        <div class="message-staff-tag">${state.currentStaff?.occupation || 'Staff'}</div>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                        <span style="margin-left: 8px; color: #718096;">Typing...</span>
                    </div>
                `;
            }
            
            chatMessages.innerHTML = html;
            
            // Auto-scroll to bottom with smooth behavior
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }

        // Handle chat input key press
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Send message
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message || !state.currentStaff || state.isLoading || !state.apiKey) return;
            
            // Add user message to all messages
            const userMessage = {
                role: 'user',
                content: message,
                staffId: state.currentStaff.id,
                staffName: state.currentStaff.name,
                staffRole: state.currentStaff.occupation,
                timestamp: new Date().toISOString()
            };
            
            state.allMessages.push(userMessage);
            messageInput.value = '';
            state.isLoading = true;
            
            renderAllMessages();
            
            // Save to localStorage
            const conversationKey = `qi-conversations-${state.currentScenario.id}`;
            saveToStorage(conversationKey, state.allMessages);
            
            try {
                // Call OpenAI API directly
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4.1-mini',
                        messages: [
                            {
                                role: 'system',
                                content: `You are ${state.currentStaff.name}, a ${state.currentStaff.occupation} in a hospital quality improvement training simulation. 

Your attitude and personality:
${state.currentStaff.attitude}

Your knowledge and what you can reveal:
${state.currentStaff.knowledge}

Sample dialogue:
${state.currentStaff.sample_dialogue || "N/A"}

IMPORTANT RULES:
- Stay strictly in character as ${state.currentStaff.name} with the attitude described above
- Only reveal information that is explicitly in your knowledge section above
- BE REALISTIC: Don't volunteer large amounts of information unless specifically asked detailed questions
- Answer only what is directly asked - don't elaborate beyond the specific question
- Make the resident work for information by requiring follow-up questions for details
- If asked a general question, give a brief, surface-level response
- Require specific, targeted questions to reveal deeper insights and data
- Act like a real busy hospital employee who gives short answers unless pressed for details
- Don't reveal information you don't have or make up new facts about processes or issues
- If asked about something not in your knowledge, say you don't know or direct them to ask another staff member
- Keep initial responses brief (1-2 sentences) unless asked for specifics
- Make residents ask "why" and "how" and "when" to get the full picture
- Remember to consistently portray your described attitude and personality
- Maintain your personality and communication style throughout the conversation
- You can create mundane small talk consistent with your personality, but nothing case-relevant beyond your knowledge
- Respond naturally as if being interviewed by a resident about quality improvement issues
- Interviews should be 2-4 minutes, so be somewhat concise but thorough when sharing your knowledge`
                            },
                            { role: 'user', content: message }
                        ],
                        max_tokens: 1500,
                        temperature: 0.7
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const aiMessage = {
                        role: 'assistant',
                        content: data.choices[0].message.content,
                        staffId: state.currentStaff.id,
                        staffName: state.currentStaff.name,
                        staffRole: state.currentStaff.occupation,
                        timestamp: new Date().toISOString()
                    };
                    state.allMessages.push(aiMessage);
                } else {
                    const errorMessage = {
                        role: 'assistant',
                        content: 'Error: ' + (data.error?.message || 'Failed to get response'),
                        staffId: state.currentStaff.id,
                        staffName: state.currentStaff.name,
                        staffRole: state.currentStaff.occupation,
                        timestamp: new Date().toISOString()
                    };
                    state.allMessages.push(errorMessage);
                }
            } catch (error) {
                console.error('OpenAI API error:', error);
                const errorMessage = {
                    role: 'assistant',
                    content: 'Error: Failed to send message. Please check your API key and internet connection.',
                    staffId: state.currentStaff.id,
                    staffName: state.currentStaff.name,
                    staffRole: state.currentStaff.occupation,
                    timestamp: new Date().toISOString()
                };
                state.allMessages.push(errorMessage);
            }
            
            state.isLoading = false;
            renderAllMessages();
            renderChatArea(); // Update header after sending message
            
            // Save updated conversations to localStorage
            saveToStorage(conversationKey, state.allMessages);
        }

        // Scenario selector functions removed - not needed with separate folders

        // Clear all conversations
        // Clear conversations function removed - handled by page reload

        // Initialize interface
        function initializeInterface() {
            renderStaffList();
            renderChatArea();
            
            // Ensure chat input is visible on mobile
            if (isMobile()) {
                const chatInputContainer = document.querySelector('.chat-input-container');
                if (chatInputContainer) {
                    // Make sure the input container is in view
                    const rect = chatInputContainer.getBoundingClientRect();
                    if (rect.bottom > window.innerHeight) {
                        // If input is below viewport, adjust layout
                        const chatMessages = document.getElementById('chat-messages');
                        // if (chatMessages) {
                        //     chatMessages.style.maxHeight = `${window.innerHeight - rect.height - 200}px`;
                        // }
                    }
                }
            }
        }

        // Modal functions
        function showModal(title, content, footer = '') {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div data-modal data-active>
                    <div>
                        <header>
                            <h3>${title}</h3>
                        </header>
                        <div class="body">
                            ${content}
                        </div>
                        ${footer ? `<footer>${footer}</footer>` : ''}
                    </div>
                </div>
            `;
        }

        function hideModal() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
        }

        // Alert system
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);
            
            // Animate in
            setTimeout(() => {
                alert.classList.add('show');
            }, 100);
            
            // Remove after delay
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }, 3000);
        }

        // Generate and download transcript as RTF
        function downloadTranscriptRTF() {
            if (state.allMessages.length === 0) {
                showAlert('No conversation to export', 'error');
                return;
            }
            
            // Generate RTF content with proper formatting
            let rtfContent = '{\\rtf1\\ansi\\deff0 {\\fonttbl {\\f0 Times New Roman;}}';
            rtfContent += '\\f0\\fs24 '; // Set font and size
            
            // Add title
            rtfContent += '\\b Interview Transcript\\b0\\par\\par';
            
            // Add scenario information
            if (state.currentScenario) {
                rtfContent += `\\b Scenario:\\b0 ${state.currentScenario.name}\\par`;
                rtfContent += `\\b Date:\\b0 ${new Date().toLocaleDateString()}\\par\\par`;
            }
            
            // Process messages and format as script
            state.allMessages.forEach(message => {
                const speaker = message.role === 'user' ? 'User' : message.staffRole || message.staffName || 'Staff';
                const cleanContent = message.content
                    .replace(/\\/g, '\\\\')  // Escape backslashes
                    .replace(/\{/g, '\\{')   // Escape braces
                    .replace(/\}/g, '\\}')   // Escape braces
                    .replace(/\n/g, '\\par'); // Convert newlines to RTF paragraph breaks
                
                rtfContent += `\\b ${speaker}: \\b0${cleanContent}\\par\\par`;
            });
            
            rtfContent += '}'; // Close RTF document
            
            // Create and download the file
            const blob = new Blob([rtfContent], { type: 'application/rtf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transcript_${new Date().toISOString().slice(0, 10)}.rtf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('Transcript downloaded successfully!', 'success');
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.hasAttribute('data-modal')) {
                hideModal();
            }
        });
        
        // Handle orientation change and window resize
        let resizeTimer;
        function handleResize() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                // Adjust chat messages height on resize
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages && state.allMessages.length > 0) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                // Re-initialize mobile features if needed
                if (isMobile() && !document.body.hasAttribute('data-mobile-initialized')) {
                    initializeMobileFeatures();
                    document.body.setAttribute('data-mobile-initialized', 'true');
                }
            }, 250);
        }
        
        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', handleResize);
    </script>
</body>
</html>